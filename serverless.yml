service: product-service

plugins:
  - serverless-s3-deploy
  - serverless-functions-base-path
  - serverless-webpack
  - serverless-ssm-fetch
frameworkVersion: '3.25'

provider:
  name: aws
  runtime: nodejs14.x
  region: us-east-1
  apiName: product-service-api
  environment:
    PGPORT: 5432

custom:
  functionsBasePath: src/handlers
  serverlessSsmFetch:
    PGUSER: rds-username-${self:service}
    PGPASSWORD: rds-password-${self:service}
    PGHOST: rds-host-${self:service}
    PGDATABASE: rds-database-${self:service}
  ssmToEnvironment:
    - PGUSER
    - PGPASSWORD
    - PGHOST
    - PGDATABASE
  webpack:
    webpackConfig: "./webpack.config.js"
    includeModules: true
    keepOutputDirectory: true
  assets:
    auto: true
    targets:
      - bucket: !Ref SwaggerBucket
        empty: false
        files:
          - source: ./static/swagger/
            globs: "**"

functions:
  getProductsList:
    handler: get-products-list/get-products-list.handler
    events:
      - http:
          path: api/get-product-list
          method: get

  getProductsListById:
    handler: get-products-list-by-id/get-products-list-by-id.handler
    events:
      - http:
          path: api/get-product-list/{id}
          method: get

  createProduct:
    handler: create-product/create-product.handler
    events:
      - http:
          path: product
          method: POST
          cors: true

resources:
  Resources:
    SwaggerBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:service}-swagger
        AccessControl: PublicRead
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders: 
                - '*'
              AllowedMethods: 
                - 'GET'
              AllowedOrigins: 
                - '*'

    WebAppS3BucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket:
          Ref: SwaggerBucket
        PolicyDocument:
          Statement:
            - Sid: PublicReadGetObject
              Effect: Allow
              Action: s3:GetObject
              Resource: arn:aws:s3:::${self:service}-swagger/*
              Principal: '*'
